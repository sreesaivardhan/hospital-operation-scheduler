<!DOCTYPE html>
<html lang="en">
<head>
    
    <!-- Firebase SDK (compat version) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <!-- Firebase configuration -->
    <script src="assets/js/firebase-config.js"></script>
</head>
<body>
    <h1>Firebase Connection Test</h1>
    <button onclick="testConnection()">1. Test Connection</button><br><br>
    <button onclick="testFirestore()">2. Test Firestore Write</button><br><br>
    <button onclick="testFirestoreRead()">3. Test Firestore Read</button><br><br>
    <button onclick="testValidateUser()">4. Test Validate User</button><br><br>
    <button onclick="testCreateUser()">5. Test Create User</button><br><br>
    <button onclick="testSetPersistence(true)">6. Set Persistence to LOCAL</button><br><br>
    <button onclick="testSetPersistence(false)">7. Set Persistence to SESSION</button><br><br>
    <div id="result" style="margin-top: 20px; padding: 20px; border: 1px solid #ccc;"></div>

    <script>
        let logoutTimer;
        window.addEventListener("mousemove", resetTimer);
        window.addEventListener("keydown", resetTimer);

        function resetTimer() {
          clearTimeout(logoutTimer);
          logoutTimer = setTimeout(() => {
            firebase.auth().signOut();
            alert("Logged out due to inactivity");
          }, 30 * 60 * 1000); // 30 minutes
        }

        function validateUser(data) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          const passRegex = /^(?=.*[A-Z])(?=.*\d).{8,}$/;
          const hospIdRegex = /^HSP\d{3}$/;

          if (!emailRegex.test(data.email)) return "Invalid email format";
          if (!passRegex.test(data.password)) return "Password must be 8+ chars, 1 capital, 1 number";
          if (!hospIdRegex.test(data.hospitalId)) return "Hospital ID must be like HSP001";
          if (!["admin", "user"].includes(data.role)) return "Invalid role";
          return null;
        }

        function testConnection() {
            try {
                if (typeof firebase !== 'undefined') {
                    document.getElementById('result').innerHTML = '‚úÖ Firebase SDK loaded successfully!';
                    
                    if (typeof window.db !== 'undefined' && window.db !== null) {
                        document.getElementById('result').innerHTML += '<br>‚úÖ Database object is available!';
                        document.getElementById('result').innerHTML += '<br>‚úÖ Ready to test Firestore operations!';
                    } else {
                        document.getElementById('result').innerHTML += '<br>‚ùå Database object not found!';
                        console.log("window.db:", window.db);
                    }
                } else {
                    document.getElementById('result').innerHTML = '‚ùå Firebase SDK not loaded!';
                }
            } catch (error) {
                document.getElementById('result').innerHTML = `‚ùå Error: ${error.message}`;
                console.error("Connection test error:", error);
            }
        }

        async function testFirestore() {
            try {
                // Check if database is available
                if (!window.db) {
                    document.getElementById('result').innerHTML = '‚ùå Database not available! Test connection first.';
                    return;
                }

                document.getElementById('result').innerHTML = 'üîÑ Writing to Firestore...';

                // Test writing to Firestore
                const docRef = await window.db.collection('test').add({
                    message: 'Hello Firebase!',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    testDate: new Date().toISOString(),
                    browser: navigator.userAgent.split(' ')[0]
                });
                
                document.getElementById('result').innerHTML = 
                    `‚úÖ Write Test Successful!<br>` +
                    `üìù Document written with ID: ${docRef.id}<br>` +
                    `üéØ Check Firebase Console ‚Üí Firestore ‚Üí 'test' collection<br>` +
                    `üîó Firestore is working perfectly!`;
                
                console.log('Firebase write test successful! Document ID:', docRef.id);
                
            } catch (error) {
                document.getElementById('result').innerHTML = 
                    `‚ùå Write Error: ${error.message}`;
                console.error('Firebase write test failed:', error);
            }
        }

        async function testFirestoreRead() {
            try {
                // Check if database is available
                if (!window.db) {
                    document.getElementById('result').innerHTML = '‚ùå Database not available! Test connection first.';
                    return;
                }

                document.getElementById('result').innerHTML = 'üîÑ Reading from Firestore...';

                // Test reading from Firestore
                const snapshot = await window.db.collection('test').orderBy('timestamp', 'desc').limit(5).get();
                
                if (snapshot.empty) {
                    document.getElementById('result').innerHTML = '‚ö†Ô∏è No test documents found! Write some data first using "Test Firestore Write".';
                    return;
                }
                
                let results = '<h3>‚úÖ Recent Test Documents:</h3>';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    results += `<div style="border: 1px solid #eee; padding: 10px; margin: 5px; border-radius: 5px;">`;
                    results += `<strong>üìÑ Document ID:</strong> ${doc.id}<br>`;
                    results += `üí¨ Message: ${data.message || 'N/A'}<br>`;
                    results += `üìÖ Date: ${data.testDate || 'N/A'}<br>`;
                    results += `üåê Browser: ${data.browser || 'N/A'}`;
                    results += `</div>`;
                });
                
                document.getElementById('result').innerHTML = results;
                console.log('Firebase read test successful!');
                
            } catch (error) {
                document.getElementById('result').innerHTML = 
                    `‚ùå Read Error: ${error.message}`;
                console.error('Firebase read test failed:', error);
            }
        }

        function testValidateUser() {
          // Example user data for testing
          const userData = {
            email: "test@example.com",
            password: "Password1",
            hospitalId: "HSP001",
            role: "admin"
          };
          const error = validateUser(userData);
          if (error) {
            console.error("‚ùå Validation failed:", error);
            document.getElementById('result').innerHTML = `‚ùå Validation failed: ${error}`;
            return;
          }
          document.getElementById('result').innerHTML = "‚úÖ Validation passed!";
          console.log("‚úÖ Validation passed!");
        }

        async function testCreateUser() {
          // Example user data for testing
          const userData = {
            email: "testuser@example.com",
            password: "Password1",
            hospitalId: "HSP002",
            role: "user"
          };
          const error = validateUser(userData);
          if (error) {
            document.getElementById('result').innerHTML = `‚ùå Validation failed: ${error}`;
            return;
          }
          try {
            await auth.createUserWithEmailAndPassword(userData.email, userData.password);
            document.getElementById('result').innerHTML = `‚úÖ User created: ${userData.email}`;
          } catch (error) {
            console.error("üî• Auth error:", error.message);
            document.getElementById('result').innerHTML = `üî• Auth error: ${error.message}`;
          }
        }

        async function testSetPersistence(rememberMe) {
          try {
            await firebase.auth().setPersistence(
              rememberMe
                ? firebase.auth.Auth.Persistence.LOCAL
                : firebase.auth.Auth.Persistence.SESSION
            );
            document.getElementById('result').innerHTML = `‚úÖ Auth persistence set to ${rememberMe ? 'LOCAL' : 'SESSION'}`;
          } catch (error) {
            document.getElementById('result').innerHTML = `‚ùå Error setting persistence: ${error.message}`;
            console.error('Persistence error:', error);
          }
        }

        // Auto-test connection when page loads
        window.addEventListener('load', function() {
            setTimeout(testConnection, 1000);
        });
    </script>
</body>
</html>
